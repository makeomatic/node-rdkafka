version: v1.0
name: "@makeomatic/node-rdkafka"
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  prologue:
    commands:
      - sem-version node 18
      - curl -fsSL https://get.pnpm.io/install.sh | env PNPM_VERSION=7.25.1 sh -
      - source /home/semaphore/.bashrc
      - pnpm config set store-dir=~/.pnpm-store
      - checkout
      - git submodule init
      - git submodule update
      - cache restore node-$(checksum pnpm-lock.yaml)
      - pnpm i --frozen-lockfile --prefer-offline --ignore-scripts
      - cache store node-$(checksum pnpm-lock.yaml) ~/.pnpm-store
  env_vars:
  - name: BUILD_LIBRDKAFKA
    value: '0'

blocks:
  - name: verify
    dependencies: []
    skip:
      when: "tag =~ '.*'"
    task:
      secrets:
        - name: semantic-release
      jobs:
      - name: test & publish binaries
        commands:
          - ./ci/semantic-release.sh
  - name: prebuild-binaries
    dependencies: []
    run:
      when: "tag =~ '.*'"
    task:
      secrets:
        - name: aws-s3-credentials
      jobs:
      - name: pre-build & publish binaries
        matrix:
        - env_var: NODE_VER
          values: ["16", "18", "19"]
        - env_var: platform
          values: ["-rdkafka", "-debian-rdkafka"]
        commands:
          - cp ~/.env.aws-s3-credentials .env
          - env IMAGE_TAG=${NODE_VER}${platform} UID=${UID} PNPM_STORE=$(pnpm config get store-dir) docker-compose up -d
          - docker-compose exec tester pnpm i --frozen-lockfile --prefer-offline --ignore-scripts
          - docker-compose exec tester pnpm binary:build
          - docker-compose exec tester pnpm binary:package
          - docker-compose exec tester pnpm binary:test
          - docker-compose exec tester pnpm binary:publish
