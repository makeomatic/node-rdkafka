version: v1.0
name: "@makeomatic/node-rdkafka"
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

fail_fast:
  stop:
    when: "branch != 'master'"

auto_cancel:
  running:
    when: "branch != 'master'"

global_job_config:
  prologue:
    commands:
      - sem-version node 16
      - curl -f https://get.pnpm.io/v6.16.js | node - add --global pnpm@6
      - pnpm config set store-dir=~/.pnpm-store
      - checkout
      - cache restore node-$(checksum pnpm-lock.yaml)
      - pnpm i --frozen-lockfile --prefer-offline --ignore-scripts
      - sudo chgrp -hR +1000 ~/.pnpm-store ./ # so that it matches node uid/gid in the docker container
      - cache store node-$(checksum pnpm-lock.yaml) ~/.pnpm-store
  env_vars:
  - name: BUILD_LIBRDKAFKA
    value: '0'

blocks:
  - name: test
    dependencies: []
    task:
      jobs:
      - name: test & publish binaries
        commands:
          - touch .env
          - env UID=${UID} PNPM_STORE=$(pnpm config get store-dir) docker-compose up -d
          - docker-compose exec tester pnpm i
          - docker-compose exec tester pnpm test
          - docker-compose exec tester pnpm test:e2e
  - name: publish
    dependencies: ["test"]
    task:
      secrets:
        - name: semantic-release
      jobs:
      - name: publish
        commands:
          - pnpm semantic-release
  - name: prebuild-binaries
    dependencies: ["publish"]
    task:
      secrets:
        - name: aws-s3-credentials
      jobs:
      - name: pre-build & publish binaries
        matrix:
        - env_var: NODE_VER
          values: ["16", "17"]
        - env_var: platform
          values: ["", "-debian"]
        commands:
          - export IMAGE_TAG=${NODE_VER}${platform}
          - cp ~/.env.aws-s3-credentials .env
          - env UID=${UID} PNPM_STORE=$(pnpm config get store-dir) docker-compose up tester --wait
          - docker-compose exec tester pnpm i --frozen-lockfile --prefer-offline --ignore-scripts
          - docker-compose exec tester pnpm binary:build
          - docker-compose exec tester pnpm binary:package
          - docker-compose exec tester pnpm binary:test
          - docker-compose exec tester pnpm binary:publish
